<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>USRP Hardware Driver and USRP Manual: The Module Peripheral Manager (MPM) Architecture</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Ettus_Logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">USRP Hardware Driver and USRP Manual
   &#160;<span id="projectnumber">Version: 3.15.0.main-0-37b7dc22</span>
   </div>
   <div id="projectbrief">UHD and USRP Manual</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('page_mpm.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">The Module Peripheral Manager (MPM) Architecture </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#mpm_arch">Architecture Overview</a></li>
<li class="level1"><a href="#mpm_arch_claiming">Device Claiming</a></li>
<li class="level1"><a href="#mpm_modes">Network vs. Embedded Mode</a></li>
<li class="level1"><a href="#mpm_debug">Debugging Tools</a></li>
<li class="level1"><a href="#mpm_shell_hijack">Hijack Mode</a></li>
</ul>
</div>
<div class="textblock"><p>For embedded USRP devices, there is an additional layer of control that UHD uses to access, configure, and control the hardware: The Module Peripheral Manager (MPM) daemon. In most cases, users of UHD do not need to know any details about MPM, but for some advanced use cases, it can be a useful tool.</p>
<h1><a class="anchor" id="mpm_arch"></a>
Architecture Overview</h1>
<p>Devices built using the MPM architecture must be capable of running an embedded Linux system. Within that system, the MPM daemon is continuously running and will allow access to device through a network-RPC based API. The UHD session calling into the device will thus be able to access that high-level API instead of directly having to interact with registers or other low-level components. This way, there is only a single driver in UHD for all MPM-powered devices.</p>
<p>The source code for the MPM daemon is located in the <code>mpm/</code> subdirectory of the UHD repository (note that the UHD library's source code is located in the <code>host/</code> subdirectory). MPM is written in Python 3, C, and C++14.</p>
<p>When starting a UHD session to control an MPM device, UHD will, under the hood, first try to access MPM over a network link to gain full control of the device. Once it has accessed MPM, it will send commands to MPM to start initializing the device for streaming usage.</p>
<p>The MPM RPC connection is only used for command &amp; control. Data is streamed over a separate connection, directly accessing the FPGA. This combines the flexibility of a network-RPC control with the high performance of direct streaming access.</p>
<h1><a class="anchor" id="mpm_arch_claiming"></a>
Device Claiming</h1>
<p>For most functionality, only a single UHD session can control MPM at the same time. To guarantee this, MPM implements a claiming mechanism. At the beginning of a UHD session, UHD will attempt to claim a device, which will either fail, or will succeed and create a <b>token</b>. This token can be used by the controlling UHD session to access peripherals which require exclusive access. UHD needs to re-claim the device within a certain interval to not lose access to the device. If UHD fails to claim a device, the assumption is made that the UHD process has terminated, and MPM will disallow further access until another, valid claim has been made.</p>
<p>This is similar to the X3x0, which uses a claiming mechanism controlled by the ZPU.</p>
<h1><a class="anchor" id="mpm_modes"></a>
Network vs. Embedded Mode</h1>
<p>Devices such as the N310 allow running a UHD session both on the device, as well as off device. The former is called <em>Embedded Mode</em>, the latter <em> Network Mode</em>.</p>
<p>In both cases, UHD will connect to MPM over a network socket. This allows the usage of the exact same driver for network and embedded modes, and thus, the same software can be compiled against UHD in both modes (keep in mind that the embedded systems are usually not as powerful as dedicated computers, so typically, high-performance applications will always run in network mode).</p>
<h1><a class="anchor" id="mpm_debug"></a>
Debugging Tools</h1>
<p>The <code>mpm/tools/</code> subdirectory provides a useful tool for debugging and interacting with MPM called <code>mpm_shell.py</code>. It is a command line tool to directly access MPM commands. Like MPM, it requires Python 3. It can be invoked as follows: </p><pre class="fragment">$ python3 tools/mpm_shell.py [-c] ni-n3xx-ABCD123
</pre><p>The <code>-c</code> switch will attempt to claim the device. The only other command line argument is a network address at which the device can be reached.</p>
<p>If the connection succeeds, commands can be directly entered on the command line. MPM Shell supports tab completion and on-line help using the <code>?</code> operator: By appending it to a command, its docstring will be displayed. </p><pre class="fragment">&gt; get_clock_source?
</pre><p>Arguments to the commands can simply be appended to the command itself: </p><pre class="fragment">&gt; set_clock_source external
</pre><p>Arguments can also be Python expression, if the first character after the command itself is an <code>=</code> symbol: </p><pre class="fragment">&gt; set_db_eeprom =[0, open('eeprom.dat', 'w').read()]
</pre><p>In this example, a list is created where the first element is a '0', and the second element is a string, read from a binary file. The list will be expanded to become the function arguments. In this case, the RPC call <code>set_db_eeprom</code> must thus have 2 arguments with the appropriate argument types.</p>
<p>Note that MPM Shell can make use of non-standard RPC features, such as propagation of Python exceptions, which makes it a versatile debugging tool.</p>
<h1><a class="anchor" id="mpm_shell_hijack"></a>
Hijack Mode</h1>
<p>In hijack mode, MPM Shell is launched after another process, such as a UHD session, is already controlling the device. By passing the token to MPM Shell, it can access the device and perform low-level operations on the device. The token can be gained by scanning the log messages of the UHD session.</p>
<p>It can be invoked as follows: </p><pre class="fragment">$ python3 tools/mpm_shell.py -j $TOKEN ni-n3xx-ABCD123</pre> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
